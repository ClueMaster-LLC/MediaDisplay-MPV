#!/bin/sh
set -e

echo "=== ClueMaster Audio Script ==="

# Check /dev/snd presence
if [ ! -d /dev/snd ]; then
  echo "âŒ /dev/snd not found. ALSA devices not accessible."
else
  echo "âœ… ALSA device nodes detected:"
  ls -1 /dev/snd/
fi

# Start PulseAudio if not running
if ! pgrep -x pulseaudio > /dev/null; then
  echo "âš ï¸  PulseAudio not running, starting now..."
  "$SNAP/bin/pulseaudio" &
  sleep 2
else
  echo "âœ… PulseAudio is already running."
fi

# Check sinks
echo "ğŸ” Checking PulseAudio sinks..."
if pactl list short sinks | grep -i dummy > /dev/null; then
  echo "âŒ Dummy sink detected. Restarting PulseAudio..."
  pulseaudio -k
  sleep 1
  "$SNAP/bin/pulseaudio" &
  sleep 2
else
  echo "âœ… Valid sinks detected:"
  pactl list short sinks
fi

# Set volume and unmute
echo "ğŸ”Š Setting sink volume to 100% and unmuting..."
pactl set-sink-mute @DEFAULT_SINK@ 0 || true
pactl set-sink-volume @DEFAULT_SINK@ 100% || true

# Show final audio status
echo "ğŸ›  Final audio sink list:"
pactl list short sinks

echo "=== Audio Check Complete ==="
