name: cluemaster-mediadisplay-core # you probably want to 'snapcraft register <name>'
base: core20 # the base snap is the execution environment for this snap
version: '1.0.18' # just for humans, typically '1.2+git' or '1.3.2'
summary: Clumaster.io Media Display for Escape Rooms # 79 char long summary
description: |
  ClueMaster Media Display is a Dynamic TV Display software for escape rooms.
  It shows escape room countdown timers, visual text messages, video, audio,
  and photo clues.

grade: stable # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots

apps:
  cluemaster-mediadisplay-core:
    daemon: simple
    restart-condition: always
    command-chain:
      - env-setup
    command: usr/local/bin/x11_kiosk_launch $SNAP/bin/desktop-launch $SNAP/bin/prepare-launch $SNAP/cluemaster_display
    plugs:
      - home
      - desktop
      - wayland
      - x11
      - network
      - opengl
      - network-bind
      - audio-playback
      - shutdown
      - process-control
      - mount-observe
      - network-control
    environment:
      DISABLE_WAYLAND: 1

parts:
  copy-source-code:
    after: [desktop-qt5]
    plugin: dump
    source: cluemaster_display/
    stage-packages:
      - ffmpeg
      - libass9
      - mpv
      - alsa-base
      - locales
      - libvdpau1
      - i965-va-driver
      - libmpv1
      - va-driver-all
      - vdpau-driver-all
      - mesa-va-drivers
      - libvdpau-va-gl1
      - libglu1-mesa
      - samba-libs
      - git
      - python3-dbus
      - qtwayland5
      - mesa-utils
      - libgl1-mesa-dri
      - python3-pyqt5.qtmultimedia
      - libqt5multimedia5-plugins

    stage-snaps: [mir-kiosk-x11]

  extras:
    plugin: dump
    source: static/
    organize:
      "prepare-launch": "bin/"

  desktop-qt5:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: qt
    plugin: make
    make-parameters: ["FLAVOR=qt5"]
    build-packages:
      - build-essential
      - qtbase5-dev
      - dpkg-dev
    stage-packages:
      - libxkbcommon0
      - ttf-ubuntu-font-family
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - gnome-themes-standard
      - shared-mime-info
      - libqt5gui5
      - libgdk-pixbuf2.0-0
      - libqt5svg5 # for loading icon themes which are svg
      - try: [appmenu-qt5] # not available on core18
      - locales-all
      - xdg-user-dirs
      - libdrm2
      - libgbm1
      - fcitx-frontend-qt5

    stage:
      - -usr/lib/x86_64-linux-gnu/dri/d3d12_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/i915_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/i965_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/iris_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/kms_swrast_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/nouveau_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/nouveau_vieux_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/r200_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/r300_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/r600_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/radeon_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/radeonsi_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/swrast_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/virtio_gpu_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/vmwgfx_dri.so
      - -usr/lib/x86_64-linux-gnu/dri/zink_dri.so
      - -usr/lib/x86_64-linux-gnu/libLLVM-12.so.1
      - -usr/lib/x86_64-linux-gnu/libdrm_intel.so.1.0.0
      - -usr/lib/x86_64-linux-gnu/libtiff.so.5.5.0
      - -usr/share/doc/libdrm-common/changelog.Debian.gz
      - -usr/share/doc/libdrm2/changelog.Debian.gz
      - -usr/share/doc/libgbm1/changelog.Debian.gz
      - -usr/share/doc/libglapi-mesa/changelog.Debian.gz
      - -usr/share/doc/libllvm12/changelog.Debian.gz
      - -usr/share/doc/libtiff5/changelog.Debian.gz


layout:
  /usr/share/X11:
    bind: $SNAP/usr/share/X11
  /usr/bin/xkbcomp:
    symlink: $SNAP/usr/bin/xkbcomp
  /usr/share/icons:
    bind: $SNAP/usr/share/icons
  /usr/share/fonts:
    bind: $SNAP/usr/share/fonts
  /usr/local/share/fonts:
    bind: $SNAP/usr/local/share/fonts
  /etc/fonts:
    bind: $SNAP/etc/fonts